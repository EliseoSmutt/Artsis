<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js" charset="UTF-8"></script>
    <script type="text/javascript">
        google.charts.load('current', { 'packages': ['corechart'] });
        google.charts.setOnLoadCallback(initialize);

        var chart;

        function initialize() {
            var currentYear = new Date().getFullYear();
            document.getElementById('yearSelect').value = currentYear;
            document.getElementById('monthSelect').value = "0";
            cargarDatos(currentYear, 0);
        }

        function cargarDatos(year, month) {
            var url = 'https://localhost:7077/api/Funcion/genero-mas-recaudador?year=' + year + '&month=' + month;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log("Datos recibidos:", data);

                    if (!Array.isArray(data) || data.length === 0) {
                        document.getElementById('chart_div').innerHTML = "<p>No hay datos de funciones para el mes y a�o seleccionados.</p>";
                        return;
                    }

                    var dataArray = [['G�nero', 'Entradas vendidas']];
                    data.forEach(function (item) {
                        dataArray.push([item.generoNombre, item.totalEntradasVendidas])
                    })

                    var title = '/*TITLE_PLACEHOLDER*/';
                    if (month > 0) {
                        var monthName = new Date(year, month - 1).toLocaleString('es', { month: 'long' });
                        title += `, ${monthName} ${year}`;
                    } else {
                        title += `, ${year}`;
                    }

                    // Actualizar el contenido del h2
                    document.getElementById('chart-title').innerText = title;

                    drawChart(dataArray, title);
                })
                .catch(error => {
                    console.error('Error al obtener datos:', error);
                    document.getElementById('chart_div').innerHTML = "<p>Error al obtener datos.</p>";
                });
        }

        function drawChart(dataArray, title) {
            var data = google.visualization.arrayToDataTable(dataArray);

            var numberOfGenres = dataArray.length - 1;

            var baseColor = '#B11C3C';
            var colors = generateShades(baseColor, numberOfGenres,25,50);

            var options = {
                pieHole: 0.4,
                colors: colors,

                backgroundColor: '#040006',
                chartArea: {
                    top: 25,      // Espacio superior para el título
                    bottom: 80,
                    left:'28%',
                    width: '90%', // Ajustar ancho del área del gráfico
                    height: '90%' // Ajustar altura del área del gráfico
                },
                pieSliceTextStyle: {//etiquetas
                    fontSize: 23,
                    bold:true,
                    color: '#DFD9BB' 
                },
                legend: {// leyendas
                    position: 'right',
                    alligment:'center',
                    textStyle: {
                        color: '#DFD9BB', 
                        fontSize:18
                    }
                }
            };

            chart = new google.visualization.PieChart(document.getElementById('chart_div'));

            chart.draw(data, options);
        }

        function onYearChange() {
            var selectedYear = document.getElementById('yearSelect').value;
            var selectedMonth = document.getElementById('monthSelect').value;
            cargarDatos(selectedYear, selectedMonth);
        }
        function onMonthChange() {
            var selectedYear = document.getElementById('yearSelect').value;
            var selectedMonth = document.getElementById('monthSelect').value;
            cargarDatos(selectedYear, selectedMonth);
        }
        function generateShades(baseColor, numberOfShades, minLightness = 50, maxLightness = 70) {
            // Convertir el color base (hexadecimal) a RGB
            var red = parseInt(baseColor.substring(1, 3), 16);
            var green = parseInt(baseColor.substring(3, 5), 16);
            var blue = parseInt(baseColor.substring(5, 7), 16);

            // Convertir de RGB a HSL
            const rgbToHsl = (r, g, b) => {
                r /= 255;
                g /= 255;
                b /= 255;
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;

                if (max === min) {
                    h = s = 0; // Es un gris
                } else {
                    const diff = max - min;
                    s = l > 0.5 ? diff / (2 - max - min) : diff / (max + min);
                    switch (max) {
                        case r: h = (g - b) / diff + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / diff + 2; break;
                        case b: h = (r - g) / diff + 4; break;
                    }
                    h /= 6;
                }

                return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
            };

            // Convertir de HSL a RGB
            const hslToRgb = (h, s, l) => {
                s /= 100;
                l /= 100;
                const c = (1 - Math.abs(2 * l - 1)) * s;
                const x = c * (1 - Math.abs((h / 60) % 2 - 1));
                const m = l - c / 2;
                let r = 0, g = 0, b = 0;

                if (h >= 0 && h < 60) { r = c; g = x; b = 0; }
                else if (h >= 60 && h < 120) { r = x; g = c; b = 0; }
                else if (h >= 120 && h < 180) { r = 0; g = c; b = x; }
                else if (h >= 180 && h < 240) { r = 0; g = x; b = c; }
                else if (h >= 240 && h < 300) { r = x; g = 0; b = c; }
                else if (h >= 300 && h < 360) { r = c; g = 0; b = x; }

                r = Math.round((r + m) * 255);
                g = Math.round((g + m) * 255);
                b = Math.round((b + m) * 255);

                return [r, g, b];
            };

            // Convertir el color base de RGB a HSL
            let [h, s, l] = rgbToHsl(red, green, blue);

            var shades = [];
            for (var i = 0; i < numberOfShades; i++) {
                // Ajustar la luminosidad dentro del rango permitido
                let step = (maxLightness - minLightness) / (numberOfShades - 1);
                let newL = Math.min(maxLightness, Math.max(minLightness, minLightness + i * step));

                // Opcional: variar ligeramente el tono (hue)
                let newH = h + i * 10; // Ajustar el tono en +10 grados por iteración
                if (newH > 360) newH -= 360; // Mantener el tono dentro de 0-360

                // Convertir de HSL a RGB
                const [newR, newG, newB] = hslToRgb(newH, s, newL);

                // Convertir a formato RGB/HEX
                const shade = `rgb(${newR}, ${newG}, ${newB})`;
                shades.push(shade);
            }

            return shades;
        }


        //function generateShades(baseColor, numberOfShades) {
        //    // Convertimos el color hexadecimal a valores RGB
        //    var red = parseInt(baseColor.substring(1, 3), 16); // R
        //    var green = parseInt(baseColor.substring(3, 5), 16); // G
        //    var blue = parseInt(baseColor.substring(5, 7), 16); // B

        //    var shades = [];
        //    for (var i = 0; i < numberOfShades; i++) {
        //        // Variamos los valores RGB para generar tonos
        //        var factor = 1 - i * 0.1; // Reduce el brillo gradualmente (10% por iteración)
        //        var newRed = Math.min(255, Math.max(0, Math.floor(red * factor)));
        //        var newGreen = Math.min(255, Math.max(0, Math.floor(green * factor)));
        //        var newBlue = Math.min(255, Math.max(0, Math.floor(blue * factor)));

        //        // Convertimos los valores RGB a formato hexadecimal
        //        var shade = `rgb(${newRed}, ${newGreen}, ${newBlue})`;
        //        shades.push(shade);
        //    }

        //    return shades;
        //}


    </script>
    <style>
        body {
            background-color: #040006; 
            color: white; 
            font-family: Arial, sans-serif;
            margin: 0
        }
        #selectors-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            margin-top: 30px;
        }
        select {
            background-color: #DFD9BB;
            font-size: 18px; 
            padding: 10px; 
            width: 200px;
            height: 50px; 
            margin: 10px; 
            border-radius: 5px;
            border: 1px solid #ccc; 
        }
        #chart_div {
            display: flex;
            background-color: #040006;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 15px;
            width: 100%;
            height: 80%;
        }
    </style>
</head>
<body>
    <div id="selectors-container">
        <select id="yearSelect" onchange="onYearChange()">
        </select>
        <script>
            var currentYear = new Date().getFullYear();
            var select = document.getElementById('yearSelect');
            for (var y = currentYear; y > currentYear - 5; y--) {
                var opt = document.createElement('option');
                opt.value = y;
                opt.textContent = y;
                if (y === currentYear) opt.selected = true;
                select.appendChild(opt);
            }
        </script>
        <select id="monthSelect" onchange="onMonthChange()">
            <option value="0" selected>Seleccione un mes</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>
    </div>

    <h2 id="chart-title" style="text-align: center; color: #DFD9BB; margin: 10px 0; font-size: 24px;">
        Cantidad de entradas vendidas por género
    </h2>

    <div id="chart_div"></div>
</body>
</html>
